
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Bug track: Issue with block/vmdk - Virt Block</title>
	<meta name="author" content="Fam Zheng">

	
	<meta name="description" content="Bug report: I tried to boot the vmdk generated by the Haiku build system here but it
aborted. It seems the header has the capacity field set to 0, to &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Virt Block" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">Virt Block</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:famz.github.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:famz.github.com">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Bug Track: Issue With Block/vmdk</h2>
	<div class="entry-content"><p>Bug report:</p>

<!-- more -->


<blockquote><p>I tried to boot the vmdk generated by the Haiku build system here but it
aborted.</p>

<p>It seems the header has the capacity field set to 0, to mean that there is no
embedded grain directory if I understand the vbox sources&#8230;</p>

<p>At least the same image boots perfectly in VBox.</p>

<p>If anyone wants to test :</p>

<p>http://haiku-files.org/vmware/</p>

<p>any image should do.</p>

<p>They are generated by:</p>

<p>http://dev.haiku-os.org/browser/haiku/trunk/src/tools/vmdkimage/vmdkimage.cpp#L303</p>

<p>The mention in vbox:</p>

<p>http://www.virtualbox.org/browser/trunk/src/VBox/Storage/VMDK.cpp#L2796</p>

<p>I might have a closer look at some point but I don&#8217;t know when.</p>

<p>François.</p></blockquote>

<hr />

<p>The haiku vmdk image is special, it is composed of</p>

<pre><code>Host Sparse Extent Header + Descriptor file + Flat data
</code></pre>

<p>Where header fields capacity, <code>gdOffset</code> and
<code>rgdOffset</code> are zero, and the following descriptor specifies the extent to be
FLAT pointing to the file itself with offset 128 and the data start from offset
0×10000.</p>

<p>Using sparse header with flat data is uncommon, and obviously beyond definition
of the specification. However both VMware and VirtualBox support such case.
Furthermore, as it is tested, the vmdk file name must be the same with the one
in descriptor for VMware to be correctly attached, just like how descriptor
file + separate flat extent work.</p>

<p>The solution could be:</p>

<p>Test <code>header.capacity</code> when opening, when it is zero (which should never be for
normal sparse vmdk), abort opening it as normal sparse but instead reopen by
the descriptor.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2011-07-21T00:00:00+08:00" pubdate data-updated="true">Jul 21<span>st</span>, 2011</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/gsoc/'>gsoc</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    Fam Zheng

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>